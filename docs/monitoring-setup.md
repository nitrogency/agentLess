# Secure Agentless Device Monitoring

This document explains the secure agentless monitoring system implemented in the IDS platform.

## Overview

The monitoring system uses a secure, agentless approach where:

1. No monitoring scripts are left on target devices
2. All monitoring is performed from the central server via SSH
3. Target devices only need a minimal monitoring user with limited permissions
4. SSH key-based authentication is used for security

## Components

### 1. Device Enrollment (enlist.sh)

The `enlist.sh` script sets up a dedicated monitoring user on target devices. This user:
- Has a limited set of sudo permissions for monitoring commands
- Uses SSH key-based authentication only
- Can be configured with random names for enhanced security

### 2. Server-Side Monitoring (monitoring.sh)

The `monitoring.sh` script runs on the server and:
- Connects to registered devices via SSH
- Collects system information, network connections, user activity, and process data
- Analyzes the collected data for anomalies
- Updates device status in the database

### 3. Automated Monitoring (setup-monitoring-cron.sh)

The `setup-monitoring-cron.sh` script sets up a cron job that:
- Runs the monitoring script every 5 minutes
- Automatically monitors all registered devices
- Logs monitoring activities to `/var/log/ids/monitoring.log`

## Security Benefits

This approach offers several security advantages:

1. **Reduced Attack Surface**: No scripts or agents are installed on target devices
2. **Centralized Control**: All monitoring logic remains on the server
3. **Least Privilege**: The monitoring user has only the necessary permissions
4. **Secure Authentication**: SSH key-based authentication prevents password attacks
5. **Audit Trail**: All monitoring activities originate from the server and can be logged

## Performance Optimizations

The monitoring system includes several optimizations for efficiency:

1. **Single SSH Connection**: Each device is monitored using a single SSH connection for all commands, reducing overhead
2. **Parallel Processing**: When monitoring multiple devices, each device is processed independently
3. **Efficient Data Collection**: Commands are batched and run in sequence on the target device
4. **Minimal Resource Usage**: The monitoring process uses minimal resources on both the server and target devices

## Setup Instructions

### 1. Generate SSH Keys

If you don't already have SSH keys, generate them:

```bash
# Generate login SSH key (if you don't already have one)
ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa

# The monitoring key will be automatically generated by the enlist.sh script
# if it doesn't exist at ~/.ssh/ids_monitoring_key
```

### 2. Copy SSH Key to Target Device

Copy your SSH key to the target device for the login user:

```bash
ssh-copy-id -i ~/.ssh/id_rsa.pub username@target_ip
```

Replace `username` with the username on the target device and `target_ip` with the IP address of the target device.

### 3. Enrolling a Device

To enroll a device for monitoring:

```bash
./scripts/enlist.sh [options] TARGET_IP
```

Options:
- `-u, --user USERNAME`: Remote username to create (default: ids_monitor)
- `-g, --group GROUPNAME`: Remote group to create (default: ids_monitor)
- `-k, --key KEY_PATH`: Path to monitoring SSH key (default: $HOME/.ssh/ids_monitoring_key)
- `-K, --login-key KEY_PATH`: Path to login SSH key (default: $HOME/.ssh/id_rsa)
- `-p, --port PORT`: SSH port (default: 22)
- `-r, --random`: Generate random user and group names
- `-l, --login USERNAME`: Username to login with (default: root)
- `-P, --password PASSWORD`: Sudo password for the login user (if required)

Example:
```bash
./scripts/enlist.sh -u monitor_user -g monitor_group -r -l ubuntu 192.168.1.100
```

If sudo requires a password on the target system, you can either:
- Provide it with the `-P` option: `./scripts/enlist.sh -l ubuntu -P mypassword 192.168.1.100`
- Let the script prompt you for the password during execution

### 4. Setting Up Automated Monitoring

To enable automatic monitoring of all devices:

```bash
./scripts/setup-monitoring-cron.sh
```

This will create a cron job that runs the monitoring script every 5 minutes.

### 5. Manual Monitoring

To manually monitor a specific device:

```bash
./scripts/monitoring.sh -u USERNAME -i IP_ADDRESS [-p PORT] [-k KEY_PATH]
```

To manually monitor all registered devices:

```bash
./scripts/monitoring.sh --auto
```

## Troubleshooting

If you encounter issues with the monitoring system:

1. Check SSH connectivity to the target device
2. Verify that the monitoring user has the necessary sudo permissions
3. Check the monitoring logs at `/var/log/ids/monitoring.log`
4. Ensure the SSH key is properly set up on both the server and target device

## Data Storage

Monitoring data is stored in the following locations:

- System information: `/var/lib/ids/data/system_*.json`
- Network information: `/var/lib/ids/data/network_*.log`
- User activity: `/var/lib/ids/data/users_*.log`
- Process information: `/var/lib/ids/data/processes_*.log`
- Analysis results: `/var/log/ids/analysis_*.log`
